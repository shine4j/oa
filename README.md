# oa
架构设计文档




杨星 Noah_Yang

2019/10/14



架构方案、技术选型、及部分通用规格


 
目录
文档变更记录	2
引言	3
目的	3
范围	3
问题总结	3
前阶段系统运行总结	3
系统总体架构设计	4
系统软件架构	4
系统逻辑架构	4
系统部署架构	7
部署图	7
服务器	8
系统交互架构	8
交互图	8
功能架构	9
逻辑图	9
用例图	9
系统专题设计	10
前台层	11
网关层	12
中间层	14
底层	15
工具包	15









文档变更记录
更改人	日期	更改内容
noah_yang	2019/10/10	创建文件
Cory_liu	2019/10/16	新增功能架构
noah_yang	2019/10/22	修改服务器部署
		
		
		


































引言
目的
1.	开发人员了解系统整体架构及技术选型。
2.	统一开发技术栈。
3.	定义开发规范。
范围
	文档适用于项目经理, 项目团队, 高层经理。
问题总结
前阶段系统运行总结
之前的审批中心系统，因经验不足，开发仓促，架构上存在诸多问题，主要体现如下：

1.	模块之间耦合过度，不利于扩展功能与优化性能。
2.	性能不佳，仅三个模块的调用链，响应超过4s的调用时间，最佳响应时间应控制在1~2s之内（主要由于底层过于依赖存储过程）。
3.	系统依赖网络环境，业务文件与部署机器绑定，更换IP影响附件下载。
4.	页面不支持复杂业务扩展，现有项目的json字符串不支持复杂业务扩展，例如：{姓名:"小小乐",年龄:23,工作:“程序猿”}，不支持扩展，无法做到可见性控制，审批中可录入，后期的权限控制。
5.	邮件发送功能过于简单，不利于扩展各种流程对邮件模板的要求。
6.	缺少权限控制，现有系统对基本没有支持权限控制。
7.	缺少运维组件，错误排除比较困难。
8.	UI体验差，现有前端UI风格不统一，用后端渲染前端，影响客户体验。









系统总体架构设计
系统软件架构
系统逻辑架构
 
	整体把系统分为四部分：
1.	Core部分
2.	数据消息部分
3.	边缘部分
4.	运维部分

Core部分
	该部分包含审批中心模块、微信审批中心模块、邮件解析模块、权限管理模块、邮件定制模块、各类流程模块、邮件发送模块、审批接口模块等
	这些模块是整个系统的核心，各模块之间通过rpc（dubbo实现）进行交互。






数据消息部分
	该部分主要包含数据库、redis、mq。
	 
Redis
 哨兵模式，该模式主要是保证项目的高可用，保证redis服务挂掉后，其他服务器能继续提供服务。

主要作用：
1.	对系统热点数据进行缓存，进行冷热数据进行分离。
2.	隔离数据库与接口，保证大量请求不直接命中数据库，缓解数据库查询压力。
3.	分布式锁，原子操作。
4.	对用户表单进行暂存（该方案有待讨论）





Mq
	引入mq主要是为了做消息分发，以及系统解耦。解耦主要是体现在审批中心与审批接口之间的消息传递，降低系统延迟，优化体验。

	边缘部分	
	该部分，主要是邮件服务模块，鉴权与授权模块，文件模块。
	
	文件模块
	该模块主要是选用FastDFS。
FastDFS是一个开源的轻量级分布式文件系统，它对文件进行管理，功能包括：文件存储、文件同步、文件访问（文件上传、文件下载）等，解决了大容量存储和负载均衡的问题。特别适合以文件为载体的在线服务，如相册网站、视频网站等等。
 FastDFS为互联网量身定制，充分考虑了冗余备份、负载均衡、线性扩容等机制，并注重高可用、高性能等指标，使用FastDFS很容易搭建一套高性能的文件服务器集群提供文件上传、下载等服务。
支持高可用、高负载、线性扩容。
运维部分
	主要分为三部分，客户操作日志，运维日志收集，dubbo治理服务
	ELK
	 
由于每个服务日志存储在本地，不方便排查异常信息，因此需要对每个系统的日志进行收集整理，比较成熟的方案是ELK，ELK由Elasticsearch、Logstash和Kibana三部分组件组成:
    Elasticsearch是个开源分布式搜索引擎，它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful风格接口，多数据源，自动搜索负载等。
    Logstash是一个完全开源的工具，它可以对你的日志进行收集、分析，并将其存储供以后使用
    kibana 是一个开源和免费的工具，它可以为 Logstash 和 ElasticSearch 提供的日志分析友好的 Web 界面，可以帮助您汇总、分析和搜索重要数据日志。
客户日志
	使用aop切入方式，使用自定义注解，异步推送到数据库或中间件。
	
系统部署架构
部署图
 

服务器
	基础服务分别部署到两台服务器上，文件服务单独一台服务器
	(2台)
部署服务器规格如下：
		Cpu 2.8GHZ以上（该指标影响系统计算性能，可以后期升级）
		内存8g以上(影响系统缓存容量及部署服务数，可以后期升级)
		硬盘 50G左右
（1台）
	文件服务器规格如下:
		Cpu 无特殊要求
		内存 无特殊要求
		硬盘 100G以上
系统交互架构
交互图
	 



功能架构
逻辑图
 
用例图

 
系统专题设计
	该系统为一个分布式系统，关系如下。
 
前台层
	1.前端分离技术栈：vue  vue-router  vuex   element/ant design  webpack

	2.后端渲染前端技术栈(new)：vue  element 
	
	3.后端渲染前端技术栈(old)：layui  jq 
	

以上是比较流行的前台实现方式。







技术对比

	前端分离技术栈	后端渲染前端技术栈(new)	后端渲染前端技术栈(old)
上手难度	高	偏高	适中
组件丰富度	丰富	较丰富	一般
页面流畅度	高	一般	一般
页面转场	方便	一般	一般
整体界面体验	高	适中	一般
扩展性	好	一般	差
组件重用	好	差	差


	基于以上技术对比，现阶段，默认投入前后端分离技术栈，虽然前期投入多，但是后期的产出、质量与体验远远高出后端渲染技术栈的。

网关层
	网关层使用nginx + Keepalived双主互备模式。该模式保证请求均衡负载的情况下，实现了nginx的高可用（故障自动转移）。网络拓扑如下：
	 
Keepalived
Keepalived是一个基于VRRP协议来实现的服务高可用方案，可以利用其来避免IP单点故障，类似的工具还有heartbeat、corosync、pacemaker。但是它一般不会单独出现，而是与其它负载均衡技术（如lvs、haproxy、nginx）一起工作来达到集群的高可用。
 













中间层
	前台与中间层交互统一使用restful进行交互，具体请见 restful规范定义文档。
	中间层使用的是dubbo，dubbo架构图如下
	
	 
dubbo扩展
	由于系统为分布式系统，调用链跨多个系统，日志无法确定调用链在不同系统之间请求的唯一，所以需要扩展dubbo包或引入分布式追踪系统，鉴于引入新系统的单点故障无法保证，且暂时不需要追踪系统的高级特性，所以暂时打算扩展dubbo，预留后期的追踪系统的升级空间。
	dubbo扩展主要依赖于spi。
SPI机制简述
SPI 全称为 Service Provider Interface，是一种服务发现机制。SPI 的本质是将接口实现类的全限定名配置在文件中，并由服务加载器读取配置文件，加载实现类。这样可以在运行时，动态为接口替换实现类。正因此特性，我们可以很容易的通过 SPI 机制为我们的程序提供拓展功能。SPI 机制在第三方框架中也有所应用，比如 Dubbo 就是通过 SPI 机制加载所有的组件。不过，Dubbo 并未使用 Java 原生的 SPI 机制，而是对其进行了增强，使其能够更好的满足需求。
其他扩展
	暂时无其他扩展需求，预留扩展空间。
底层
	系统底层存储依赖于oracle数据库。以及redis以及mq等集群，提供系统的数据存储，缓存，消息分发，解耦等功能。
工具包
	项目统一依赖一个父pom，pom中定义了统一依赖的springboot版本以及dubbo等，定义了插件与打包方式。
分环境打包 dev 、test 、prod分别为开发环境，测试环境及正式环境。 

	
